flowchart TD
    START((ğŸš€ Start)) --> waiting_for_interaction

    subgraph waiting_for_interaction["â³ waiting_for_interaction"]
        W1["Type: waiting"]
        W2["Waits for user input"]
    end

    waiting_for_interaction -->|"user_input"| step1

    subgraph handle_interaction["ğŸ¤– handle_interaction (llm_processor, temp: 0.3)"]
        
        subgraph step1["Step 1: Get Employee Info"]
            S1["ğŸ“‹ Call get_employee_laptop_info<br/>from employee-info MCP server"]
        end

        subgraph step2["Step 2: Query Policy"]
            S2["ğŸ“š Query laptop-refresh KB<br/>for refresh interval policy"]
        end

        subgraph step3["Step 3: Calculate Eligibility"]
            S3["ğŸ§® Convert ages to months<br/>Compare: laptop_age >= policy_months<br/>Determine ELIGIBLE / NOT ELIGIBLE"]
        end

        subgraph step4["Step 4: Present Info"]
            S4["ğŸ“„ Display ALL laptop info fields<br/>Show eligibility summary<br/>Ask if user wants to proceed"]
        end

        subgraph step5["Step 5: Get Laptop Options"]
            S5["ğŸ” Query laptop-refresh KB<br/>Get ALL laptops for user's location<br/>with FULL specifications"]
        end

        subgraph step6["Step 6: Present Options"]
            S6["ğŸ“ Show numbered list of laptops<br/>Include ALL 15 spec fields<br/>Ask user to select ONE"]
        end

        subgraph step7["Step 7: Confirm Selection"]
            S7["â“ MANDATORY confirmation step<br/>Ask: 'Would you like to proceed<br/>with creating a ServiceNow ticket?'"]
        end

        subgraph step8["Step 8: Create Ticket"]
            S8["ğŸ« Call open_laptop_refresh_ticket<br/>ONLY after explicit confirmation<br/>Check for duplicate tickets first"]
        end

        subgraph step9["Step 9: Wrap Up"]
            S9["âœ… Ask if anything else needed<br/>If 'no' â†’ task_complete_return_to_router"]
        end

        step1 --> step2 --> step3 --> step4
        step4 -->|"User wants to proceed"| step5
        step5 --> step6
        step6 -->|"User selects laptop"| step7
        step7 -->|"User confirms"| step8
        step8 --> step9
    end

    step4 -->|"User declines / out of scope"| route_back
    step9 -->|"User says 'no'"| task_complete

    subgraph route_back["â†©ï¸ Return to Router"]
        RB["User requests routing<br/>or asks off-topic question"]
    end

    subgraph task_complete["âœ… Task Complete"]
        TC["task_complete_return_to_router<br/>_should_return_to_routing = true"]
    end

    route_back --> END
    task_complete --> END
    
    step9 -->|"User has more questions"| waiting_for_interaction

    subgraph END["ğŸ”š end (terminal)"]
        E1["Reset to handle_interaction<br/>Clear messages & state<br/>Return to routing agent"]
    end

    style START fill:#22c55e,color:#fff
    style END fill:#ef4444,color:#fff
    style waiting_for_interaction fill:#3b82f6,color:#fff
    style handle_interaction fill:#f3e8ff,color:#1e1b4b
    style task_complete fill:#10b981,color:#fff
    style route_back fill:#6366f1,color:#fff
    style step1 fill:#c4b5fd,color:#1e1b4b
    style step2 fill:#c4b5fd,color:#1e1b4b
    style step3 fill:#c4b5fd,color:#1e1b4b
    style step4 fill:#a78bfa,color:#fff
    style step5 fill:#c4b5fd,color:#1e1b4b
    style step6 fill:#c4b5fd,color:#1e1b4b
    style step7 fill:#fbbf24,color:#1e1b4b
    style step8 fill:#34d399,color:#1e1b4b
    style step9 fill:#a78bfa,color:#fff

